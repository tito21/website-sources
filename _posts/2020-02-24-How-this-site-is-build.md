---
layout: post
title: "How this site is build"
slug: "how-this-site-is-build"
date: 2020-02-26 20:20:20 -0300
draft: true
categories: ["Python", "pandoc", "github", "english"]
tags: ["markdown", "site generator", "pandoc", "websites"]
description: This site is generated using pandoc managed by a set of python
             scripts.
---

The old version of this site was hosted on Github pages and manage using Jekyll.
That system worked very well, I could write blog post on Markdown, easily tweak
the CSS and HTML of the theme and the website was always updated on every
commit. It only have one problem: Jekyll is written in Ruby. This is (imo) a
major problem as you have to manage a local Ruby environment, which can be
difficult if you don't really use it for anything else. For me using "gems" for
plugins and Jekyll itself was a estrange trickery I never really understand. I
also think the whole Jekyll ecosystem is a bit overkill for just converting
Markdown to HTML especially in light of tools like [pandoc](https://pandoc.org).

With this in mind I decided to write my own tool for generating websites. In
designing my new system I wanted it to be as easy to use and flexible so the
site can be ported with ease. Also the system should be properly documented and
self explanatory. A problem I have with the previous system was that every six
month or so when I update the blog I had to google how to preview the site, how
to build, etc. This article is part of that documentation.

The final product is really just a python script for running pandoc with custom
arguments. The script can read YAML frontmater of a page to fill in necessary
details and customize its build processes and it is configurable with more YAML
in a `config.yml` file.

The old site was based on one of the default templates and I wanted something
more original. I first wrote a pandoc template to use a the foundation for the
website that supports all the features I needed for my website (namely MathJax,
syntax highlighting and general webpage footer and headers). Most of the content
can be configure with YAML either on the frontmater of the file or in a
`config.yml` file.

## Using pandoc to fill in variables

Some pages need to be generated with information from other pages (e.g. the list
of post on the main page). This data is not filled by python but from pandoc
itself. The Markdown version of these pages it is used as a pandoc template to
get its values expanded from a YAML file on a first run and then converted to the
site on a second pass. For example `index.md` has the lines:

```markdown
$for(posts)$ $-- Iterates over each post and puts the data on the posts variable
## [$posts.title/nowrap$]($posts.url/nowrap$)

::: sub-title
$posts.date$
:::

:::: description
$posts.description$
::::
$endfor$
```

And `post.yml`:

```YAML
posts:
- title: Post 1
  url: post1.html
  date: 19-08-01
  description: Some description
- title: Post 2
  url: post2.html
  date: 19-09-09
  description: Some even more descriptive description
```

after running
`pandoc index.md -t index.md -o tmp/index.md --metadata-file post.yml` gets
expanded to this:

```markdown
## [Post tile 1](posts/post1.html)

::: sub-title
01 Aug 2019
:::

:::: description
Some description
::::

## [Post tile 2](posts/post2.html)

::: sub-title
09 Sep 2019
:::

:::: description
Some even more descriptive description
::::
```

which can be converted to HTML using the same settings as the rest of the
website. `post.yml` is generated by python by collecting the frontmatter from
the post and dumping it to YAML with [pyYAML](https://pyyaml.org/).

This trick it is not in the oficial pandoc documentation but it's discussed by
on an [open issue on pandoc's github](https://github.com/jgm/pandoc/issues/1950)
(from where I got the idea).

## Hosting on Github

As I have no budget for a website so every thing is hosted on Github. All the
sources are on a git repo ([here](https://github.com/tito21/website-sources)),
this includes all the raw Markdown, scrips and configuration files. When the
site it's build onto the public folder it is pulled to a diferente repo at
<https://github.com/tito21/website-sources>. This repo is a user GitHub Page,
which is the site itself. To have a git repositories inside another the public
folder is a git submodule. Committing and pushing to this repo is done
automatically by a script I took from [Hugo's documentation](https://gohugo.io/hosting-and-deployment/hosting-on-github/).

## Conclusion

I'm very please with my system. I thing I achieve my goal of doing every thing
by hand and being simple enough publish an article without thinking much of
about the details. Personally I also like the new look to the site. I felt the
old look was generic and it was very obvious it came form a template. The build
times are rather slow (~2s on my machine) which makes ~200ms per page. This is
fine for now but I will like to optimize it a bit in the future. Some ideas for
optimization are: use multiple pandoc threads and only rebuild changed files.

# Extra: generating `robots.txt` and `sitemap.xml`

One of the true advantages of a system like Jekyll is the ability to easily add
plugins. A `sitemap.xml` is generated with the website. Hopefully this can be
replaced with a pure python script. The script works by finding every HTML file
in the site's folder and then using the `xml.etree` module to create a xml
representation according to the [sitemaps.org](https://www.sitemaps.org) schema.
`robots.txt` is then generated by simply making the appropriate file.

<script src="https://gist.github.com/tito21/f9ae856eee2f3f41b4da1490238a9097.js"></script>